name: Upgrade uv.lock

on:
  schedule:
  - cron: 37 10 * * 1
  workflow_dispatch:

jobs:
  upgrade-requirements:
    name: Upgrade uv.lock
    runs-on: ubuntu-latest
    if: github.repository == 'PlasmaPy/PlasmaPy'

    steps:

      - name: Check out repository
      uses: actions/checkout@v6
      with:
        persist-credentials: false

    - name: Install uv
      uses: astral-sh/setup-uv@v7
      with:
        enable-cache: true

    - name: Run Nox session to upgrade uv.lock
      run: uv run noxfile.py -s lock

    # When a pull request is created by a GitHub Action, normally the
    # checks will not be run. While the simplest workaround would have
    # been to open and close the PR, an alternative is to authenticate
    # with GitHub App generated tokens (as done below). The instructions
    # for how to do this are in the documentation for the
    # peter-evans/create-pull-request action.

    - name: Generate token
      uses: tibdex/github-app-token@3beb63f4bd073e61482598c45c71c1019b59b73a # v2.1.0
      id: generate_token
      with:
        app_id: ${{ secrets.APP_ID }}
        private_key: ${{ secrets.APP_PRIVATE_KEY }}

    - name: Create pull request
      uses: peter-evans/create-pull-request@98357b18bf14b5342f975ff684046ec3b2a07725 # v8.0.0
      with:
        title: Upgrade uv.lock
        add-paths: uv.lock
        commit-message: Upgrade uv.lock with 'nox -s lock'
        # The PR body message is generated dynamically via `nox -s lock` in CI
        body-path: .github/content/upgrade-uv-lock-pr-body.md
        labels: no changelog entry needed, requirements
        branch: upgrade-uv-lock
        base: main
        delete-branch: true
        token: ${{ steps.generate_token.outputs.token }}
