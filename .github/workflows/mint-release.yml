name: Prepare a release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Date-based version üè∑Ô∏è
        required: true
        default: 2025.8.0rc1
      doi:
        description: Reserved DOI from Zenodo
        required: true
        default: 10.5281/zenodo.16747747


permissions:
  contents: write

defaults:
  run:
    shell: bash

jobs:

  tag:
    runs-on: ubuntu-latest

    steps:

    - name: Validate version input
      run: |
        if [[ ! ${VERSION} =~ ^2[0-9]{3}\.[0-9]+\.[0-9]+((a|b|rc)[0-9]+)?$ ]]; then
        echo "::error ::Provide a calendar version like `2025.8.0` (or `2025.8.0a0`, `2025.8.0b0`, or `2025.8.0rc1` for pre-releases)"
        exit 1
        fi
      env:
        VERSION: ${{ github.event.inputs.version }}

    - name: Validate DOI input
      run: |
        if [[ ! ${DOI} =~ ^10\.[0-9]{4,9}/\S+$]]; then
        echo "::error ::Provide a valid DOI reserved from Zenodo."
        exit 1
        fi
      env:
        DOI: ${{ github.event.inputs.doi }}

    - name: Configure git
      run: |
        git config --global user.email "team@plasmapy.org"
        git config --global user.name "PlasmaPy Release Bot"

    - name: Checkout code
      uses: actions/checkout@v4
      with:
        persist-credentials: 'false'

    - name: Check out branch
      run: |
        git branch -f ${BRANCH}
        git switch ${BRANCH}
      env:
        BRANCH: prepare-v${{ github.event.inputs.version }}

    - name: Install the latest version of uv
      uses: astral-sh/setup-uv@v6

#    - name: Update CITATION.cff & citation.rst with the DOI for the new version.
#      run: |
#        python .github/scripts/citation_updater.py CITATION.cff docs/about/citation.rst docs/changelog/index.rst --version=${{ github.event.inputs.version }} --doi=${{ github.event.inputs.doi}}
#        git add .
#        git commit -m "Run citation_updater.py"

    - name: Update version and DOI in CITATION.cff and docs/about/citation.rst
      run: |
        uv run .github/scripts/citation_updater.py CITATION.cff docs/about/citation.rst docs/changelog/index.rst --version=${VERSION} --doi=${DOI}
        git add .
        git commit -m "Update version & DOI in CITATION.cff & citation.rst"

#    - name: Build changelog with towncrier
#      run: |
#        towncrier build --yes --version ${{ github.event.inputs.tag }} --draft | tee docs/changelog/${{ github.event.inputs.tag }}.rst
#        sed -i -e :a -e '/^\n*$/{$d;N;ba' -e '}' docs/changelog/${{ github.event.inputs.tag }}.rst   # strip empty lines
#        git add .
#        towncrier build --yes --version ${{ github.event.inputs.tag }}
#        git commit --allow-empty -nm "Add changelog entries for v${{ github.event.inputs.tag }}"

    - name: Build changelog with towncrier
      run: |
        uvx nox -s "changelog(final)"
        git add .
        git commit --allow-empty -m "Build changelog with towncrier for ${VERSION}"
      env:
        VERSION: ${{ github.event.inputs.version }}

    - name: Run pre-commit

#    - name: Tag the release
#      run: |
#        git tag "v${{ github.event.inputs.tag }}" -m "Version v${{ github.event.inputs.tag }}"
#
#    - name: Print tags
#      run: |
#        git tag
#
#    - name: Push tag, branch state
#      run: |
#        git push -u origin $VERSION $BRANCH
#      env:
#        GITHUB_TOKEN: ${{ secrets.WORKFLOW_TOKEN }}
#
