# Verify that a pull request has a valid changelog entry.
#
# The verification is skipped if either of the `no changelog entry needed`
# or `skip changelog checks` labels have been applied. These labels are
# automatically applied to certain automated or minor pull requests.

name: Changelog

on:
  pull_request:
    types: [opened, synchronize, reopened, edited, labeled, unlabeled]

concurrency:
  group: changelog-${{ github.event.pull_request.number }}
  cancel-in-progress: true

env:
  CHANGELOG_INSTRUCTIONS: "⚠️ Please add a changelog entry at `changelog/NUMBER.TYPE.rst`, where `NUMBER` is the pull request number and `TYPE` is one of `feature`, `trivial`, `doc`, `internal`, `bugfix`, `breaking`, or `removal`.\n\nMinor change such as typo fixes and hyperlink updates do not need a changelog entry.\n\nFor details, see: https://docs.plasmapy.org/en/latest/contributing/changelog_guide.html#adding-a-changelog-entry"


jobs:
  add-no-changelog-label:
    name: Add no changelog label
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:

    - name: Add no changelog label for PR titles matching regular expressions
      if: ${{ !contains(github.event.pull_request.labels.*.name, 'skip changelog checks') }}
      uses: actions/github-script@v8
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}

        # Written in JavaScript, using Node.js syntax.
        script: |
          // Define regular expressions for pull requests not requiring
          // a changelog entry.
          function buildPatterns() {
            return [
              /^bump .* from .* to .*/i,
              /autoupdate/i,
              /fix typo/i,
              /update changelog entries/i,
              /update changelog prior to/i,
              /update pinned requirements/i,
            ];
          }

          // Check whether the pull request title matches any of the provided patterns.
          function matchesTitle(title, pullRequestTitlePatterns) {
            const t = title || "";
            return pullRequestTitlePatterns.some(rx => rx.test(t));
          }

          // Retrieve pull request metadata using the GitHub REST API.
          async function getPullRequest(octokit, ctx) {
            const { data } = await octokit.rest.pulls.get({
              owner: ctx.repo.owner,
              repo: ctx.repo.repo,
              pull_number: ctx.issue.number,
            });
            return data;
          }

          // Label a pull request.
          async function addLabel(octokit, ctx, issueNumber, label) {
            await octokit.rest.issues.addLabels({
              owner: ctx.repo.owner,
              repo: ctx.repo.repo,
              issue_number: issueNumber,
              labels: [label],
            });
          }

          const pullRequestTitlePatterns = buildPatterns();
          const pr = await getPullRequest(github, context);

          if (matchesTitle(pr.title, pullRequestTitlePatterns)) {
            await addLabel(github, context, context.issue.number, 'no changelog entry needed');
          }

  changelog_checker:
    name: Validate changelog entry
    runs-on: ubuntu-latest
    needs: add-no-changelog-label
    permissions:
      contents: read
      pull-requests: write

    steps:

    - uses: actions/checkout@v5
      with:
        sparse-checkout: |
          changelog
          pyproject.toml
        persist-credentials: false

    - name: Validate changelog entry with towncrier
      # see [tool.changelog-bot] in pyproject.toml for configuration
      uses: scientific-python/action-towncrier-changelog@v2
      # This action fails if "no changelog entry needed" is applied, so
      # use a conditional to make a changelog entry optional in this case.
      if: ${{ !( contains(github.event.pull_request.labels.*.name, 'no changelog entry needed') ) }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        BOT_USERNAME: changelog-bot

    - name: Print troubleshooting information
      if: ${{ failure() }}
      run: |
        echo -e $CHANGELOG_INSTRUCTIONS
        exit 1
